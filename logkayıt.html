<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Log Paneli</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:radial-gradient(circle at top,#0f172a,#020617);
  color:#e5e7eb;
}
header{
  padding:24px;
  text-align:center;
  font-size:26px;
  font-weight:700;
  letter-spacing:.5px;
}
.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  padding:0 24px 20px;
}
.filters input,.filters select{
  padding:10px 12px;
  border-radius:10px;
  border:none;
  background:#0b1220;
  color:#fff;
  outline:none;
}
.filters input::placeholder{color:#94a3b8}

.container{
  padding:0 24px 40px;
  display:grid;
  gap:14px;
}

.log-card{
  background:linear-gradient(180deg,#0b1220,#020617);
  border-radius:18px;
  padding:16px 18px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.05);
}

.log-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.badge.proje{background:#22c55e;color:#022c22}
.badge.personel{background:#38bdf8;color:#022b40}
.badge.transfer{background:#f97316;color:#351500}

.action{
  font-weight:700;
  font-size:15px;
}
.action.create{color:#22c55e}
.action.add{color:#22c55e}
.action.update{color:#facc15}
.action.delete,.action.remove{color:#ef4444}
.action.update-location{color:#a855f7}
.action.transfer{color:#f97316}

.meta{
  font-size:13px;
  color:#94a3b8;
  margin-top:6px;
}

.target{
  margin-top:10px;
  font-size:16px;
  font-weight:600;
}

.details{
  margin-top:10px;
  background:#020617;
  border-radius:12px;
  padding:12px;
  font-size:13px;
  color:#cbd5f5;
  display:none;
  white-space:pre-wrap;
  word-break:break-word;
}

.toggle{
  margin-top:10px;
  cursor:pointer;
  font-size:13px;
  color:#38bdf8;
}

.map a{
  color:#22c55e;
  text-decoration:none;
  font-weight:600;
}
.empty{
  text-align:center;
  padding:60px;
  color:#64748b;
  font-size:18px;
}
.action.add,
.action.create{color:#22c55e;}
.action.delete,
.action.remove,
.action.remove-all,
.action.Personel\ Silindi{color:#ef4444;}
.action.projeden-silindi{color:#facc15;}
</style>
</head>
<body>

<header>üõ°Ô∏è Admin Log Kayƒ±t Paneli</header>

<div class="filters">
  <select id="typeFilter">
    <option value="">T√ºr (T√ºm√º)</option>
    <option value="projects">Proje</option>
    <option value="personnel">Personel</option>
    <option value="transfer">Personel Transferi</option>
  </select>

  <select id="actionFilter">
    <option value="">ƒ∞≈ülem (T√ºm√º)</option>
    <option value="create">Proje Olu≈üturuldu</option>
    <option value="add">Personel Eklendi</option>
    <option value="update">G√ºncellendi</option>
    <option value="update-location">Konum G√ºncellendi</option>
    <option value="delete">Proje Silindi</option>
    <option value="remove">Personel Tamamen Silindi</option>
    <option value="transfer">Personel Transfer Edildi</option>
    <option value="projeden-silindi">Personel Projeden √áƒ±karƒ±ldƒ±</option>
  </select>

  <input id="userFilter" placeholder="Kullanƒ±cƒ± e-posta veya isim">
  <input id="searchFilter" placeholder="Proje / Personel / TC">
  <input type="date" id="dateFilter" placeholder="Tarih se√ßin">
</div>

<div class="container" id="logContainer"></div>

<script>
const app = firebase.initializeApp({
  apiKey: "AIzaSyACEapdJC_e5jlRbq8M09vl-iKlvmf5kh0",
  authDomain: "logkayit-50d87.firebaseapp.com",
  databaseURL: "https://logkayit-50d87-default-rtdb.firebaseio.com",
  projectId: "logkayit-50d87"
},"logApp");

const db = app.database();
const container = document.getElementById("logContainer");
let allLogs=[];

function fetchLatestLog() {
  allLogs = [];
  db.ref("logs").once("value", snap => {
    let latestLog = null;
    snap.forEach(typeSnap => {
      typeSnap.forEach(l => {
        const log = l.val();
        log.type = typeSnap.key;
        if(!latestLog || log.timestamp > latestLog.timestamp) latestLog = log;
      });
    });
    if(latestLog) allLogs.push(latestLog);
    db.ref("projectTransfers").once("value", transferSnap => {
      let latestTransfer = null;
      transferSnap.forEach(t => {
        const tr = t.val();
        const parts = tr.date.split(".");
        if(parts.length !== 3) return;
        const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        const ts = new Date(`${isoDate}T${tr.time}`).getTime();
        if(isNaN(ts)) return;
        if(!latestTransfer || ts > latestTransfer.timestamp){
          latestTransfer = {
            type: "transfer",
            action: "transfer",
            user: tr.performedByName,
            details: {
              oldProjectName: tr.oldProjectName,
              newProjectName: tr.newProjectName,
              personName: tr.personName,
              personTcNo: tr.personTcNo
            },
            timestamp: ts
          };
        }
      });
      if(latestTransfer) allLogs.push(latestTransfer);
      allLogs.sort((a,b)=>b.timestamp - a.timestamp);
      render();
    });
  });
}

fetchLatestLog();

dateFilter.addEventListener("input", () => {
  const selectedDate = new Date(dateFilter.value);
  fetchLogsForDate(selectedDate);
});

function fetchLogsForDate(date) {
  const start = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
  const end = start + 86400000 - 1;
  allLogs = [];
  db.ref("logs").once("value", snap => {
    snap.forEach(typeSnap => {
      typeSnap.forEach(l => {
        const log = l.val();
        if(log.timestamp >= start && log.timestamp <= end){
          log.type = typeSnap.key;
          allLogs.push(log);
        }
      });
    });
    db.ref("projectTransfers").once("value", transferSnap => {
      transferSnap.forEach(t => {
        const tr = t.val();
        const parts = tr.date.split(".");
        if(parts.length !== 3) return;
        const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        const ts = new Date(`${isoDate}T${tr.time}`).getTime();
        if(isNaN(ts)) return;
        if(ts >= start && ts <= end){
          allLogs.push({
            type: "transfer",
            action: "transfer",
            user: tr.performedByName,
            details: {
              oldProjectName: tr.oldProjectName,
              newProjectName: tr.newProjectName,
              personName: tr.personName,
              personTcNo: tr.personTcNo
            },
            timestamp: ts
          });
        }
      });
      allLogs.sort((a,b)=>b.timestamp - a.timestamp);
      render();
    });
  });
}

function render(){
  container.innerHTML="";
  const tf=typeFilter.value;
  const af=actionFilter.value;
  const uf=userFilter.value.toLowerCase();
  const sf=searchFilter.value.toLowerCase();
  const df = dateFilter.value ? new Date(dateFilter.value).getTime() : null;
  let shown=0;
  allLogs.forEach(l=>{
    if(tf && l.type!==tf) return;
    if(af && l.action!==af) return;
    if(uf) {
      let logUser = l.user || "";
      if(l.type === "personnel") logUser = l.details.adSoyad || l.details.tc || "";
      if(l.type === "projects") logUser = l.user || "";
      if(!logUser.toLowerCase().includes(uf)) return;
    }
    if(sf && !JSON.stringify(l.details).toLowerCase().includes(sf)) return;
    if(df) {
      const start = df;
      const end = df + 86400000 - 1;
      if(l.timestamp < start || l.timestamp > end) return;
    }
    shown++;
    const d=new Date(l.timestamp);
    const target = (l.type === "personnel") 
                 ? l.details.adSoyad || l.details.tc || "-" 
                 : (l.type === "transfer")
                     ? `${l.details.personName} ‚Ä¢ ${l.details.oldProjectName} ‚Üí ${l.details.newProjectName}`
                     : l.details.projectName || "-";
    const card=document.createElement("div");
    card.className="log-card";
    card.innerHTML=`
      <div class="log-head">
        <span class="badge ${l.type==="projects"?"proje":l.type==="personnel"?"personel":"transfer"}">
          ${l.type==="projects"?"PROJE":l.type==="personnel"?"PERSONEL":"TRANSFER"}
        </span>
        <span class="action ${l.action}">${actionTR(l.action)}</span>
      </div>
      <div class="meta">${d.toLocaleString()} ‚Ä¢ ${l.user||"?"}</div>
      <div class="target">${target}</div>
      <div class="toggle">Detayƒ± G√∂ster</div>
      <div class="details">${JSON.stringify(l.details,null,2)}
      ${l.details.lat?`\n\nHarita: https://www.google.com/maps?q=${l.details.lat},${l.details.lng}`:""}</div>
    `;
    const toggle=card.querySelector(".toggle");
    const det=card.querySelector(".details");
    toggle.onclick=()=>{det.style.display=det.style.display==="block"?"none":"block";
      toggle.textContent=det.style.display==="block"?"Detayƒ± Gizle":"Detayƒ± G√∂ster";
    };
    container.appendChild(card);
  });
  if(!shown) container.innerHTML='<div class="empty">Filtreye uygun kayƒ±t yok</div>';
}

function actionTR(a){
  return {
    create: "Proje Olu≈üturuldu",
    delete: "Proje Silindi",
    "update-location": "Konum G√ºncellendi",
    add: "Personel Eklendi",
    remove: "Personel Tamamen Silindi",
    "projeden-silindi": "Personel Projeden √áƒ±karƒ±ldƒ±",
    transfer: "Personel Transfer Edildi"
  }[a] || a;
}

[typeFilter, actionFilter, userFilter, searchFilter, dateFilter].forEach(e => e.addEventListener("input", render));
</script>
</body>
</html>
