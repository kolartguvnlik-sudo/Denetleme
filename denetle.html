
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Denetleme Sistemi</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<script src="https://unpkg.com/html5-qrcode"></script>


<style>
/* ===== GENEL ===== */
body{
 margin:0;
 font-family:'Segoe UI',system-ui;
 background:radial-gradient(circle at top,#111a3a,#050914);
 color:#fff;
}

section{
 padding:24px 20px;
 max-width:420px;
 margin:auto;
 animation:fade .3s ease;
}

@keyframes fade{
 from{opacity:0;transform:translateY(10px)}
 to{opacity:1;transform:none}
}

/* ===== FORM ===== */
input,select{
 width:100%;
 padding:14px 16px;
 margin-top:12px;
 border-radius:14px;
 background:#0f1735;
 border:1px solid #ffffff22;
 color:#fff;
 font-size:14px;
 outline:none;
}

input:focus,select:focus{
 border-color:#00e5ff;
 box-shadow:0 0 0 2px #00e5ff22;
}

/* ===== BUTON ===== */
button{
 width:100%;
 padding:14px;
 margin-top:14px;
 border-radius:16px;
 border:none;
 font-size:15px;
 font-weight:700;
 cursor:pointer;
 transition:.2s;
 background:linear-gradient(135deg,#00e5ff,#6a5cff);
 color:#000;
 box-shadow:0 10px 30px #00e5ff33;
}

button:hover{
 transform:translateY(-1px);
 box-shadow:0 14px 40px #00e5ff55;
}

button:active{
 transform:scale(.98);
}

/* ===== LÄ°STE ===== */
.list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #1b2445;
  padding: 16px 24px;
  margin: 12px 0;
  border-radius: 20px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 520px;
  gap: 16px;
  position: relative;
}

/* Ä°kon ve isim iÃ§in grup */
.guard-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1; /* isim grubunu geniÅŸletip ortaya hizalamak iÃ§in */
}

/* Ä°sim */
.guard-name {
  font-size: 16px;
  font-weight: 500;
  color: #eaf1f7;
  margin-left: 8px; /* ikon ile isim arasÄ± boÅŸluk */
}

/* DENETLENDÄ° etiketi */
.checked-label {
  background: linear-gradient(90deg, #00f0ff, #00d4ff);
  color: #000;
  padding: 6px 14px;
  border-radius: 12px;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 13px;
  margin-left: 12px;
}

/* Ara butonu */
.right-actions {
  margin-left: 8px; /* biraz sola kaydÄ±r */
}

.right-actions button {
  padding: 8px 14px;
  font-size: 14px;
  border: 1px solid #00d4ff;
  border-radius: 12px;
  background: transparent;
  color: #00f0ff;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.right-actions button:hover {
  background: #00d4ff;
  color: #000;
}


/* ===== BADGE ===== */
.badge{
 background:linear-gradient(135deg,#00e5ff,#6a5cff);
 color:#000;
 padding:4px 10px;
 border-radius:20px;
 font-size:11px;
 font-weight:800;
 box-shadow:0 0 10px #00e5ff88;
}

/* ===== BAÅLIKLAR ===== */
h2,h3{
 margin:0 0 10px;
 letter-spacing:.3px;
}

h2{
 font-size:20px;
 color:#00e5ff;
}

h3{
 font-size:15px;
 color:#8fdfff;
}

/* ===== KART ===== */
.card{
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:22px;
 border-radius:22px;
 box-shadow:0 20px 50px rgba(0,0,0,.4);
}

.row{
 display:flex;
 justify-content:space-between;
 margin:8px 0;
 font-size:14px;
}

/* ===== ALERT ===== */
.alert-box{
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:26px;
 border-radius:22px;
 box-shadow:0 30px 80px rgba(0,0,0,.6);
}
#qr-reader{
 border-radius:20px;
 overflow:hidden;
 box-shadow:0 20px 50px rgba(0,0,0,.5);
}
/* ===== KIMLIK SÃœRESÄ° UYARI ===== */
.expiry-warning{
 background:linear-gradient(135deg,#ff3b3b,#b30000);
 padding:12px 16px;
 border-radius:14px;
 font-size:14px;
 font-weight:800;
 margin-top:14px;
 color:#fff;
 text-align:center;
 box-shadow:
  0 0 15px rgba(255,0,0,.8),
  inset 0 0 10px rgba(0,0,0,.4);
 animation:pulseRed 1.2s infinite;
 transform:translateZ(0);
}

/* 3D kÄ±rmÄ±zÄ± yanÄ±p sÃ¶nme */
@keyframes pulseRed{
 0%{
  box-shadow:0 0 8px rgba(255,0,0,.4);
  transform:scale(1);
 }
 50%{
  box-shadow:0 0 30px rgba(255,0,0,1);
  transform:scale(1.03);
 }
 100%{
  box-shadow:0 0 8px rgba(255,0,0,.4);
  transform:scale(1);
 }
}
.hidden{display:none !important}
#appAlert{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.65);
 display:flex;
 align-items:center;
 justify-content:center;
 z-index:9999;
}
.danger-text{
 color:#ff4d4d;
 font-weight:800;
 text-shadow:0 0 10px rgba(255,0,0,.6);
}
html, body {
  overscroll-behavior-y: contain;
  touch-action: pan-x pan-y;
}
.offline-card {
  border: 2px solid #ff3b3b;
  box-shadow:
    0 0 0 2px rgba(255,0,0,.4),
    0 0 18px rgba(255,0,0,.6);
  animation: offlinePulse 1.4s infinite;
}

@keyframes offlinePulse {
  0%   { box-shadow: 0 0 6px rgba(255,0,0,.4); }
  50%  { box-shadow: 0 0 22px rgba(255,0,0,.9); }
  100% { box-shadow: 0 0 6px rgba(255,0,0,.4); }
}

</style>
</head>

<body>
<section id="profileBar" style="
 max-width:420px;
 margin:10px auto 0;
 background:linear-gradient(135deg,#1b2445,#202c5a);
 padding:14px 18px;
 border-radius:18px;
 display:flex;
 justify-content:space-between;
 align-items:center;
 box-shadow:0 10px 30px rgba(0,0,0,.4)
">
<div style="display:flex;flex-direction:column;gap:3px">

 <span style="
  font-size:11px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:#8fdfff;
  opacity:.9
 ">
  Denetleyen
 </span>

 <span id="profileName" style="
  font-size:16px;
  font-weight:800;
  background:linear-gradient(135deg,#00e5ff,#6a5cff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 12px rgba(0,229,255,.45);
 ">
  YÃ¼kleniyor...
 </span>
<span id="offlineStatus" style="
 display:none;
 font-size:11px;
 font-weight:800;
 color:#ff4d4d;
 text-shadow:0 0 10px rgba(255,0,0,.7);
">
 ğŸ“¡ GÃœVENLÄ° OFFLINE MOD AKTÄ°F
</span>

 <div style="
  width:36px;
  height:3px;
  border-radius:10px;
  background:linear-gradient(90deg,#00e5ff,#6a5cff);
  margin-top:4px
 "></div>

</div>


 <div style="display:flex;gap:8px">
  <button onclick="openProfile()" style="
   width:auto;
   padding:8px 12px;
   border-radius:12px;
   font-size:13px
  ">
   âš™ï¸
  </button>

  <button onclick="logout()" style="
   width:auto;
   padding:8px 12px;
   border-radius:12px;
   font-size:13px;
   background:linear-gradient(135deg,#ff4d4d,#b30000);
   color:#fff;
   box-shadow:0 6px 18px rgba(255,0,0,.5)
  ">
   â‹
  </button>
 </div>
</section>


<section id="projectPage">
<h2>ğŸ“ Proje SeÃ§</h2>
<select id="projectSelect"></select>
<button onclick="selectProject()">Devam</button>
</section>

<section id="listPage" class="hidden">
<h2 id="projectTitle"></h2>

<div id="lastPatrolInfo" class="last-patrol"></div>

<h3 id="guardTitle" style="margin:14px 0 8px;font-size:15px;color:#8fdfff">
 ğŸ“Œ Projedeki Personeller
</h3>

<div id="guardList"></div>
<button onclick="backToProject()">â¬… Proje SeÃ§imine DÃ¶n</button>
<button onclick="startPatrol()">ğŸš€ Denetleme BaÅŸlat</button>
<button onclick="finishPatrol()">ğŸ Denetlemeyi Bitir</button>

</section>

<section id="qrPage" class="hidden">
<h3>QR Okut</h3>
<button
 onclick="openManual()"
 style="
  width:auto;
  float:right;
  padding:8px 14px;
  font-size:12px;
  margin-top:-34px
 "
>
 ğŸ§ Manuel Personel Tara
</button>


<div id="qr-reader" style="width:300px"></div>

<button onclick="toggleFlash()">ğŸ”¦ Flash AÃ§ / Kapat</button>
<button onclick="refocusCamera()">ğŸ¯ Odakla</button>

</section>

<section id="manualPage" class="hidden">
<h3>ğŸ§ Manuel Personel Tara</h3>

<input
 id="manualTc"
 placeholder="TC Kimlik No"
 maxlength="11"
 inputmode="numeric"
/>

<button onclick="manualSearch()">Ara</button>
<button onclick="backToQr()">â¬… QR Okutmaya DÃ¶n</button>
</section>

<section id="requiredPage" class="hidden">
<h3>Zorunlu Bilgiler</h3>
<input id="telefon" placeholder="Telefon">
<select id="kimlikTuru">
<option value="">Kimlik TÃ¼rÃ¼</option>
<option>SilahlÄ±</option>
<option>SilahsÄ±z</option>
</select>
<input type="date" id="kimlikGecerlilik">
<button onclick="saveRequired()">Kaydet</button>
</section>

<section id="alreadyPage" class="hidden">

<h3>âš ï¸ BU PERSONEL DENETLENDÄ°</h3>
<p id="oldInfo"></p>
<button onclick="continueNewInspection()">â• Yeni Denetim</button>
<button onclick="continueUpdateInspection()">ğŸ”„ Mevcut Denetimi GÃ¼ncelle</button>

</section>

<section id="cardPage" class="hidden">
<div class="card">

<h2 id="ad"></h2>
<!-- PROFÄ°L FOTO ALANI -->
<div id="photoWrapper"
 onclick="openPhotoOptions()"
 style="
  width:120px;
  height:120px;
  border-radius:12px;
  margin:12px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0f1735;
  border:2px dashed #00e5ff88;
  cursor:pointer;
  position:relative;
 ">

 <img id="guardPhoto"
  style="
   width:100%;
   height:100%;
   border-radius:12px;
   object-fit:contain;
   display:none;
  ">

 <span id="photoPlus"
  style="font-size:42px;color:#00e5ff">+</span>

</div>





<div class="row"><span>TC</span><span id="tc"></span></div>
<div class="row"><span>Kimlik</span><span id="kimlik"></span></div>
<div class="row"><span>GeÃ§erlilik</span><span id="gecerlilik"></span></div>
<div id="expiryInfo"></div>





<button id="btnGorev" disabled onclick="saveInspection('gorevi_basinda')">
 âœ… GÃ¶revi BaÅŸÄ±nda
</button>

<button id="btnUygunsuz" disabled onclick="openUygunsuz()">
 âš ï¸ Uygunsuz
</button>

<div id="uygunsuzPanel" class="hidden">

 <select id="uygunsuzSebep">
 <h4 style="margin:0 0 10px;color:#ff5a5a">
 âš ï¸ Uygunsuzluk DetayÄ±
</h4>

  <option value="">Uygunsuzluk sebebi seÃ§</option>
  <option>Uyuyor</option>
  <option>KÄ±lÄ±k kÄ±yafet</option>
  <option>TÄ±raÅŸ olmamÄ±ÅŸ</option>
  <option>KimliÄŸi yok</option>
  <option>GÃ¶rev yerinde deÄŸildi</option>
  <option value="diger">DiÄŸer</option>
 </select>

 <input
  id="uygunsuzDiger"
  class="hidden"
  placeholder="DiÄŸer sebebi yaz"
 />

 <button onclick="saveUygunsuz()">Kaydet</button>

</div>

</div>
</section>

<script>

// ğŸ” SADECE MENÃœDEN GELEN GÄ°REBÄ°LÄ°R
if (sessionStorage.getItem("menuAllowed") !== "ok") {
  window.location.replace("index.html");
} else {
  // sadece ilk giriÅŸte izin ver
  sessionStorage.removeItem("menuAllowed");
}


const firebaseConfig = {
  apiKey: "AIzaSyDF6XwfMwASz1mHt16DrR9jjjpozP4MBlA",
  authDomain: "denetleme-78b55.firebaseapp.com",
  databaseURL: "https://denetleme-78b55-default-rtdb.firebaseio.com",
  projectId: "denetleme-78b55",
  storageBucket: "denetleme-78b55.appspot.com",
  messagingSenderId: "762780340283",
  appId: "1:762780340283:web:da64465ec4657307f64c1e"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.database();
/* ğŸ”¥ MERKEZ PERSONEL SENKRON FONKSÄ°YONU */
function syncPersonnel({ tc, adSoyad, data = {} }) {

 const updates = {};

 updates[`personnel/${tc}/tc`] = tc;
 updates[`personnel/${tc}/adSoyad`] = adSoyad;

 Object.keys(data).forEach(k => {
  updates[`personnel/${tc}/${k}`] = data[k];
 });

 return firebase.database().ref().update(updates);
}


let proje="", aktifDevriyeId=null, tcNo="", guard={}, mevcutDenetimId=null, mode="new";

/* ğŸ”¥ OFFLINE Ä°Ã‡Ä°N: PERSONEL BU PROJEDE MÄ°? */
function isPersonnelInThisProject(tc){
  const map = JSON.parse(
    localStorage.getItem("projectPersonnel_" + proje) || "{}"
  );
  return !!map[tc];
}

let qrInstance = null;
let flashOn = false;

const auth = firebase.auth();

let currentUser = null;
let currentProfileName = "";


/* ğŸ” GÄ°RÄ°Å KONTROL */
/* ğŸ” GÄ°RÄ°Å KONTROL VE STATUS GÃœNCELLEME */
/* ğŸ” GÄ°RÄ°Å KONTROL VE STATUS GÃœNCELLEME */
auth.onAuthStateChanged(user => {
  if (!user) {
    // GiriÅŸ yoksa login sayfasÄ±na at
    window.location.href = "index.html";
    return;
  }

  currentUser = user;

  // KullanÄ±cÄ± profilini yÃ¼kle
  loadProfile();

  // KullanÄ±cÄ± adÄ± / maili
  const displayName = currentUser.displayName || currentUser.email || "Ä°simsiz KullanÄ±cÄ±";

  // Status referansÄ±
  const userStatusDatabaseRef = db.ref("/status/" + user.uid);

  // Offline ve online objeleri
  const isOfflineForDB = {
    state: "offline",
    name: displayName,
    last_changed: firebase.database.ServerValue.TIMESTAMP
  };

  const isOnlineForDB = {
    state: "online",
    name: displayName,
    last_changed: firebase.database.ServerValue.TIMESTAMP
  };

  // BaÄŸlantÄ± kontrolÃ¼
  db.ref(".info/connected").on("value", snapshot => {
    if (snapshot.val() === false) {
      // BaÄŸlantÄ± yoksa offline yaz
      userStatusDatabaseRef.set(isOfflineForDB);
      return;
    }

    // Disconnect durumunda offline yaz
    userStatusDatabaseRef.onDisconnect().set(isOfflineForDB).then(() => {
      // BaÄŸlantÄ± varsa online yaz
      userStatusDatabaseRef.set(isOnlineForDB);
    });
  });
});

/* ğŸ”“ Profil YÃ¼kleme */
function loadProfile() {
  const uid = currentUser.uid;

  db.ref("users/" + uid).once("value", snap => {
    if (!snap.exists()) return;

    const d = snap.val();
    currentProfileName = d.fullName || currentUser.displayName || currentUser.email || "Ä°simsiz KullanÄ±cÄ±";
    profileName.innerText = currentProfileName;

    // ğŸ”“ BUTONLARI AKTÄ°F ET
    btnGorev.disabled = false;
    btnUygunsuz.disabled = false;
  });
}

function openProfile(){
 profileEmailInput.value = currentUser.email;
 profileModal.classList.remove("hidden");
}

function closeProfile(){
 profileModal.classList.add("hidden");
 newPassword.value = "";
}

function updatePassword(){

 const pass = newPassword.value;

 if(pass.length < 6){
  showAlert({
   title:"ZayÄ±f Åifre",
   message:"Åifre en az 6 karakter olmalÄ±",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 currentUser.updatePassword(pass)
  .then(()=>{
   showAlert({
    title:"BaÅŸarÄ±lÄ±",
    message:"Åifre gÃ¼ncellendi",
    buttons:[{text:"Tamam"}]
   });
   closeProfile();
  })
  .catch(err=>{
   showAlert({
    title:"Hata",
    message:"GÃ¼venlik nedeniyle tekrar giriÅŸ yapmanÄ±z gerekebilir",
    buttons:[{text:"Tamam"}]
   });
  });
}

/* PROJELER */
db.ref("projects").once("value",s=>{
 projectSelect.innerHTML="<option value=''>SeÃ§</option>";
 s.forEach(p=>{
  projectSelect.innerHTML+=`<option value="${p.key}">${p.val().projectName}</option>`;
 });
});

/* SAYFA YENÄ°LENÄ°RSE DEVAM */
window.onload = () => {
localStorage.removeItem("canEnterApp");

 const p = localStorage.getItem("proje");
 const d = localStorage.getItem("devriye");

 if(!p){
  localStorage.clear();
  return;
 }

 proje = p;
 aktifDevriyeId = d || null;

 // ğŸ”¥ BÃœYÃœK BAÅLIK HER ZAMAN SET EDÄ°LÄ°R
 db.ref(`projects/${p}`).once("value", snap=>{
  if(snap.exists()){
   projectTitle.innerText = snap.val().projectName;
  }
 });

 projectPage.classList.add("hidden");
 listPage.classList.remove("hidden");

 loadList();
 loadLastPatrolInfo();
};

function loadLastPatrolInfo(){

 db.ref(`projects/${proje}`).once("value", pSnap=>{

  if(!pSnap.exists()) return;

  const data = pSnap.val();
  const projeAdi = data.projectName;
  const lastEnd = data.lastPatrolEnd;
  const lastBy  = data.lastPatrolBy;

  let html = `
   <div>
    <b>ğŸ“ ${projeAdi}</b><br>
  `;

  if(!lastEnd){
   html += `ğŸš« HenÃ¼z denetlenmedi`;
  }else{
   html += `
    ğŸ•’ Son denetim:
    <span class="time">${timeAgo(lastEnd)}</span> Ã¶nce
   `;

   if(lastBy && lastBy.name){
    html += `
     <br>
     ğŸ‘¤ <b>Son Denetleyen:</b> ${lastBy.name}
    `;
   }
  }

  html += `</div>`;

  lastPatrolInfo.innerHTML = html;
 });
}






function showNoPatrol(){
 lastPatrolInfo.innerHTML = `
  <div>
   <b>ğŸ“ ${projectTitle.innerText}</b><br>
   ğŸš« HenÃ¼z denetlenmedi
  </div>
 `;
}


function selectProject(){

 if(!projectSelect.value){
  alert("LÃ¼tfen proje seÃ§");
  return;
 }

 proje = projectSelect.value;

db.ref(`projects/${proje}/personnel`).once("value", snap => {

  const map = {};

  const promises = [];

  snap.forEach(tcSnap => {
    const tc = tcSnap.key;

    promises.push(
      db.ref(`personnel/${tc}`).once("value").then(perSnap => {
        if(perSnap.exists()){
          map[tc] = true;              // ğŸ‘ˆ sadece varlÄ±k bilgisi
          cachePersonnel(tc, perSnap.val());
        }
      })
    );
  });

Promise.all(promises).then(()=>{
  localStorage.setItem(
    "projectPersonnel_" + proje,
    JSON.stringify(map)
  );

  // ğŸ”¥ ARTIK CACHE DOLU
  loadList();
});


});


 projectPage.classList.add("hidden");
 listPage.classList.remove("hidden");

 db.ref(`projects/${proje}`).once("value",s=>{
  projectTitle.innerText = s.val().projectName;
 });

 loadLastPatrolInfo();
}



 

function loadList() {
  guardList.innerHTML = ""; // Listeyi temizle
  const rendered = new Set();
  const offline = !navigator.onLine;
  const map = JSON.parse(localStorage.getItem("projectPersonnel_" + proje) || "{}");

  // Offline mod
// Offline mod
if (offline) {
  if (Object.keys(map).length === 0) {
    guardList.innerHTML = "<p>Offline modda personel bulunamadÄ±</p>";
    return;
  }

  const offlineInspections = JSON.parse(localStorage.getItem("offlineInspections") || "[]");

  Object.keys(map).forEach(tc => {
    if (rendered.has(tc)) return;
    rendered.add(tc);

    const cached = getCachedPersonnel(tc);
    const adSoyad = cached && cached.adSoyad ? cached.adSoyad : "YÃ¼kleniyor...";
    const denetlendi = offlineInspections.some(i => i.proje === proje && i.tcNo === tc);

    // ğŸ”´ KartÄ±n kÄ±rmÄ±zÄ± Ã§erÃ§eve almasÄ± iÃ§in offline-card sÄ±nÄ±fÄ±nÄ± ekliyoruz
    guardList.innerHTML += `
      <div class="list-item offline-card" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
        <span class="guard-name">ğŸ‘® ${adSoyad}</span>
        <div class="right-actions" style="display: flex; align-items: center; gap: 8px;">
          ${denetlendi ? `<span class="badge">DENETLENDÄ°</span>` : ""}
          <button class="call-btn" onclick="callGuard('${tc}')">ğŸ“ Ara</button>
        </div>
      </div>
    `;
  });

  return;
}


  // Online mod
  db.ref(`projects/${proje}/personnel`).once("value", snap => {
    if (!snap.exists()) {
      guardList.innerHTML = "<p>Bu projede personel yok</p>";
      return;
    }

    snap.forEach(tcSnap => {
      const tc = tcSnap.key;
      if (rendered.has(tc)) return;
      rendered.add(tc);

      const cached = getCachedPersonnel(tc);
      const adSoyad = cached && cached.adSoyad ? cached.adSoyad : "YÃ¼kleniyor...";

      db.ref(`denetimler/${proje}/${tc}`)
        .orderByChild("devriyeId")
        .equalTo(aktifDevriyeId)
        .limitToLast(1)
        .once("value")
        .then(dSnap => {
          const denetlendi = dSnap.exists();

          guardList.innerHTML += `
            <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
              <span class="guard-name">ğŸ‘® ${adSoyad}</span>
              <div class="right-actions" style="display: flex; align-items: center; gap: 8px;">
                ${denetlendi ? `<span class="badge">DENETLENDÄ°</span>` : ""}
                <button class="call-btn" onclick="callGuard('${tc}')">ğŸ“ Ara</button>
              </div>
            </div>
          `;
        });
    });
  });
}


function timeAgo(ms){
 const diff = Date.now() - ms;
 const dk = Math.floor(diff / 60000);
 const saat = Math.floor(dk / 60);
 const gun = Math.floor(saat / 24);

 if(gun > 0) return `${gun} gÃ¼n ${saat % 24} saat ${dk % 60} dakika`;
 if(saat > 0) return `${saat} saat ${dk % 60} dakika`;
 return `${dk} dakika`;
}



/* DEVRIYE */
function startPatrol(){
 // QR nesnesi burada oluÅŸturulmalÄ±
qrInstance = new Html5Qrcode("qr-reader");

 if(!aktifDevriyeId){
  aktifDevriyeId=db.ref(`devriyeler/${proje}`).push({
   baslangic:Date.now(),durum:"aktif"
  }).key;
  localStorage.setItem("proje",proje);
  localStorage.setItem("devriye",aktifDevriyeId);
 }
 listPage.classList.add("hidden");
 qrPage.classList.remove("hidden");

qrInstance.start({facingMode:"environment"},{fps:10,qrbox:250},t=>{
tcNo=t;
qrInstance.stop();
checkGuard();
 });
}

function checkGuard(){

 // ğŸ”Œ OFFLINE MODE â†’ HÄ°Ã‡ FIREBASEâ€™E GÄ°TME
 if(!navigator.onLine){

  if(tcNo.length !== 11){
    showAlert({
      title:"GeÃ§ersiz TC",
      message:"TC hatalÄ±",
      buttons:[{text:"Tamam"}]
    });
    return;
  }

if(!isPersonnelInThisProject(tcNo)){
  showAlert({
    title:"Offline UyarÄ±",
    message:"Bu personel bu projeye ait deÄŸil (offline)",
    buttons:[
      {
        text:"Tamam",
        onClick: () => {
          // QR sayfasÄ±nÄ± kapat
          qrPage.classList.add("hidden");

          // Manuel TC sayfasÄ±nÄ± aÃ§
          manualPage.classList.remove("hidden");

          // Input'u temizle + focus
          manualTc.value = "";
          manualTc.focus();
        }
      }
    ]
  });
  return;
}


  loadGuardFromPersonnel();
  return;
 }


 if(tcNo.length !== 11){
  showAlert({
   title:"GeÃ§ersiz QR",
   message:"TC hatalÄ±",
   buttons:[{text:"Tamam"}]
  });
  return;
 }


 // 1ï¸âƒ£ BU PROJEDE VAR MI?
 db.ref(`projects/${proje}/personnel/${tcNo}`).once("value", pSnap => {

  // âŒ BU PROJEDE YOKSA
  if(!pSnap.exists()){

    findPersonnelProject(tcNo).then(found => {

      // âŒ HÄ°Ã‡BÄ°R PROJEDE YOK
  // âŒ HÄ°Ã‡BÄ°R PROJEDE YOK
if(!found){
  showAlert({
    title:"Personel BulunamadÄ±",
    message:"Bu TC hiÃ§bir projede kayÄ±tlÄ± deÄŸil",
    buttons:[{
      text:"Tamam",
      onClick: () => {
        // Manuel TC giriÅŸine geri dÃ¶n
        manualPage.classList.remove("hidden");
        qrPage.classList.add("hidden");
        manualTc.value = "";
        manualTc.focus();
      }
    }]
  });
  return;
}


      // âš ï¸ BAÅKA PROJEDE VAR
showAlert({
  title:"Bu GÃ¼venlik Bu Projeye Ait DeÄŸil",
  message:`
    âŒ Bu personel bu projeye ait deÄŸil<br><br>
    âœ”ï¸ <b>Mevcut Projesi:</b> ${found.name}
  `,
  buttons:[
    {
      text:"ğŸŸ¢ Mesaiye Geldi",
   onClick: () => continueAsGuestGuard(true)

    },

    {
      text:"ğŸ” ArtÄ±k Bu Projede Ã‡alÄ±ÅŸacak",
      onClick: () => confirmMoveGuard(found)
    },

    {
      text:"Ä°ptal"
    }
  ]
});


    });

    return;
  }

// ğŸ” AYNI DEVRÄ°YEDE DAHA Ã–NCE DENETLENDÄ° MÄ°?
db.ref(`denetimler/${proje}/${tcNo}`)
  .orderByChild("devriyeId")
  .equalTo(aktifDevriyeId)
  .limitToLast(1)
  .once("value", snap => {

    // â— DAHA Ã–NCE DENETLENMÄ°Å â†’ BÄ°LGÄ° YÃœKLEME
    if(snap.exists()){
      snap.forEach(s => {
        mevcutDenetimId = s.key;
        const d = s.val();
        const tarih = new Date(d.tarih).toLocaleString("tr-TR");

        oldInfo.innerHTML = `
          ğŸ•’ <b>${tarih}</b><br>
          Durum: <b>${d.durum}</b>
        `;
      });

      qrPage.classList.add("hidden");
      alreadyPage.classList.remove("hidden");
      mode = "update";
      return;
    }

    // âœ… Ä°LK KEZ â†’ PERSONEL BÄ°LGÄ°LERÄ°NÄ° YÃœKLE
    mode = "new";
    loadGuardFromPersonnel();
  });


 });
}

function editKimlik(){

 // mevcut personel bilgilerini inputlara bas
 telefon.value = guard.telefon || "";
 kimlikTuru.value = guard.kimlikTuru || "";
 kimlikGecerlilik.value = guard.kimlikGecerlilik || "";

 // kartÄ± kapat, zorunlu bilgi sayfasÄ±nÄ± aÃ§
 cardPage.classList.add("hidden");
 requiredPage.classList.remove("hidden");
}
	
/* ZORUNLU */
function saveRequired(){
  if(!telefon.value || !kimlikTuru.value || !kimlikGecerlilik.value){
    showAlert({
      title: "Eksik Bilgi",
      message: "LÃ¼tfen tÃ¼m alanlarÄ± doldur",
      buttons: [{ text: "Tamam" }]
    });
    return;
  }

  const yeniTelefon = telefon.value;
  const yeniKimlikTuru = kimlikTuru.value;
  const yeniGecerlilik = kimlikGecerlilik.value;

  /* ğŸ”¥ OFFLINE-FIRST: STATE'I HEMEN GÃœNCELLE */
  guard.telefon = yeniTelefon;
  guard.kimlikTuru = yeniKimlikTuru;
  guard.kimlikGecerlilik = yeniGecerlilik;

  /* ğŸ’¾ LOCAL CACHE */
  cachePersonnel(tcNo, { ...guard });

  /* ğŸ“¦ OFFLINE Ä°SE â†’ KUYRUKLA (TEKÄ°L TC) */
  if(!navigator.onLine){
    const key = "offlinePersonnelUpdates";
    let list = JSON.parse(localStorage.getItem(key) || "[]");

    // aynÄ± TC varsa Ã¼stÃ¼ne yaz
    list = list.filter(p => p.tc !== tcNo);

    list.push({
      tc: tcNo,
      adSoyad: guard.adSoyad,
      data: {
        telefon: yeniTelefon,
        kimlikTuru: yeniKimlikTuru,
        kimlikGecerlilik: yeniGecerlilik
      }
    });

    localStorage.setItem(key, JSON.stringify(list));
  }

  /* ğŸ§¹ ZORUNLU EKRANI KAPAT */
  requiredPage.classList.add("hidden");

  /* â–¶ï¸ DENETLEME AKIÅINA DEVAM */
  loadGuardFromPersonnel();

  /* ğŸŒ ONLINE Ä°SE â†’ FIREBASE'E GÃ–NDER */
  if(navigator.onLine){
    syncPersonnel({
      tc: tcNo,
      adSoyad: guard.adSoyad,
      data: {
        telefon: yeniTelefon,
        kimlikTuru: yeniKimlikTuru,
        kimlikGecerlilik: yeniGecerlilik
      }
    }).catch(err => {
      console.warn("âš ï¸ Online sync baÅŸarÄ±sÄ±z, offline kuyruÄŸa kalÄ±r", err);
    });
  }
}


function showCard(){
 alreadyPage.classList.add("hidden");
 cardPage.classList.remove("hidden");

 ad.innerText = guard.adSoyad;
 tc.innerText = guard.tc;
 kimlik.innerText = guard.kimlikTuru;
 gecerlilik.innerText = guard.kimlikGecerlilik;

const expiry = checkKimlikExpiry(guard.kimlikGecerlilik);

// â›” Ã¶nce temizle
expiryInfo.innerHTML = "";

// ğŸš¨ UYARI VARSA
if(expiry.danger){

 expiryInfo.innerHTML = `
  <div class="expiry-warning">
   ğŸš¨ ${expiry.text}
  </div>

  <button
   onclick="editKimlik()"
   style="
    margin-top:10px;
    background:linear-gradient(135deg,#ffb347,#ffcc33);
    color:#000;
    font-weight:800;
   ">
   ğŸªª Kimlik Bilgilerini GÃ¼ncelle
  </button>
 `;
}
// âœ… UYARI YOKSA
else{
 expiryInfo.innerHTML = `
  <div style="
   margin-top:12px;
   padding:10px;
   border-radius:12px;
   background:linear-gradient(135deg,#1e2a55,#25346b);
   box-shadow:0 0 12px rgba(0,229,255,.4);
   font-size:13px;
  ">
   ${expiry.text}
  </div>
 `;
}




 if(guard.photoBase64){
  guardPhoto.src = guard.photoBase64;
  guardPhoto.style.display = "block";
  photoPlus.style.display = "none";
 }else{
  guardPhoto.style.display = "none";
  photoPlus.style.display = "block";
 }
}



function saveInspection(durum, detay=null){

 if(!currentUser || !currentUser.uid){
  alert("Oturum hazÄ±r deÄŸil, 1 saniye bekle");
  return;
 }

 if(!currentProfileName){
  alert("Profil yÃ¼klenmedi, lÃ¼tfen bekle");
  return;
 }

 let ref;

 if(mode === "update" && mevcutDenetimId){
  ref = db.ref(`denetimler/${proje}/${tcNo}/${mevcutDenetimId}`);
 }else{
  ref = db.ref(`denetimler/${proje}/${tcNo}`).push();
 }

const data = {
  durum: durum,
  tarih: Date.now(),
  devriyeId: aktifDevriyeId,

  denetleyenUid: String(currentUser.uid),
  denetleyenEmail: currentUser.email ? String(currentUser.email) : "email_yok",
  denetleyenAd: currentProfileName && currentProfileName.trim()
    ? currentProfileName
    : "Ä°simsiz KullanÄ±cÄ±"
 };
 // ğŸ”¥ SADECE MESAI BUTONUYLA GELEN DENETÄ°M
if(window.__mesaideFlag === true){
  data.mesaide = true;
  window.__mesaideFlag = false; // âš ï¸ bayraÄŸÄ± kapat
}


 if(detay){
  data.detay = detay;
 }

if(durum === "gorevi_basinda"){
  data.detay = null;
}


if(navigator.onLine){
 ref.set(data);
}else{
 const key = "offlineInspections";
 const list = JSON.parse(localStorage.getItem(key) || "[]");
 list.push({ proje, tcNo, data });
 localStorage.setItem(key, JSON.stringify(list));
}


 cardPage.classList.add("hidden");
 listPage.classList.remove("hidden");
 loadList();

 mode="new";
 mevcutDenetimId=null;
 tcNo="";
 uygunsuzPanel.classList.add("hidden");
 uygunsuzSebep.value="";
 uygunsuzDiger.value="";
 uygunsuzDiger.classList.add("hidden");
}





/* BITIR */
function finishPatrol(){




 // â— DEVRIYE BAÅLAMADIYSA
 if(!aktifDevriyeId){
  showAlert({
   title:"Denetleme Yok",
   message:"Denetleme baÅŸlamadan denetleme bitirilemez",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 showAlert({
  title: "Denetleme Bitirilsin mi?",
  message: `
   Devam edersen 
   <span class="danger-text">${projectTitle.innerText}</span> 
   iÃ§in yapÄ±lan denetleme <b>kapatÄ±lacak</b>,<br><br>
   TÃ¼m iÅŸlemler tamamlanacak ve 
   <b>giriÅŸ ekranÄ±na yÃ¶nlendirileceksin</b>.
  `,
  buttons:[
   { text:"Ä°ptal" },
   { 
    text:"Evet, Denetlemeyi Bitir",
    danger:true,
    onClick: finishPatrolConfirmed
   }
  ]
 });
}
function finishPatrolConfirmed(){

 const uid = currentUser.uid;
 const name = currentProfileName || "Ä°simsiz KullanÄ±cÄ±";
 const email = currentUser.email || "email_yok";

 const now = Date.now();

 // Åu anki tarihi okunabilir formata Ã§evir
 const formattedDate = new Date(now)
   .toLocaleString("tr-TR", {
     year: "numeric",
     month: "2-digit",
     day: "2-digit",
     hour: "2-digit",
     minute: "2-digit",
     hour12: false
   }).replace(",", ""); // 2026-02-05 18:22

 db.ref(`projects/${proje}`).update({
  lastPatrolEnd: now,           // eski sayÄ± kalsÄ±n
  lastPatrolEndText: formattedDate, // yeni okunabilir tarih
  lastPatrolBy: {
   uid,
   name,
   email
  }
 }).then(()=>{
  localStorage.clear();
  window.location.href = "menÃ¼.html";
 }).catch(()=>{
  showAlert({
   title:"Hata",
   message:"Denetleme kapatÄ±lÄ±rken hata oluÅŸtu",
   buttons:[{text:"Tamam"}]
  });
 });
}

function showAlert({title="UyarÄ±", message="", buttons=[]}){
 alertTitle.innerText = title;
alertMessage.innerHTML = message;
 alertActions.innerHTML = "";

 buttons.forEach(b=>{
  const btn=document.createElement("button");
  btn.innerText=b.text;
  btn.onclick=()=>{
   closeAlert();
   if(b.onClick) b.onClick();
  };
  alertActions.appendChild(btn);
 });

 appAlert.classList.remove("hidden");
}

function closeAlert(){
 appAlert.classList.add("hidden");
}
function checkKimlikExpiry(tarihStr){

 if(!tarihStr){
  return { danger:true, text:"âŒ Kimlik bilgisi yok" };
 }


 const today = new Date();
 const expiry = new Date(tarihStr);

 const diffMs = expiry - today;
 const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
 const diffMonths = Math.floor(diffDays / 30);

 if(diffDays <= 0){
  return {
   danger:true,
   text:"âŒ Kimlik sÃ¼resi DOLMUÅ"
  };
 }

 if(diffMonths < 6){
  return {
   danger:true,
   text:`âš ï¸ Kimlik sÃ¼resinin bitmesine ${diffMonths} ay ${diffDays % 30} gÃ¼n kaldÄ±`
  };
 }

 return {
  danger:false,
  text:`âœ… Kimlik geÃ§erli (${diffMonths} ay ${diffDays % 30} gÃ¼n kaldÄ±)`
 };
}
function openUygunsuz(){
 uygunsuzPanel.classList.remove("hidden");
 uygunsuzSebep.focus();
}


uygunsuzSebep.onchange = ()=>{
 if(uygunsuzSebep.value === "diger"){
  uygunsuzDiger.classList.remove("hidden");
 }else{
  uygunsuzDiger.classList.add("hidden");
  uygunsuzDiger.value = "";
 }
};

function saveUygunsuz(){
 if(!uygunsuzSebep.value){
  showAlert({
   title:"Eksik SeÃ§im",
   message:"Uygunsuzluk sebebi seÃ§",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 let detay = uygunsuzSebep.value;

 if(detay === "diger"){
  if(!uygunsuzDiger.value){
   showAlert({
    title:"Eksik Bilgi",
    message:"DiÄŸer sebebi yaz",
    buttons:[{text:"Tamam"}]
   });
   return;
  }
  detay = uygunsuzDiger.value;
 }

 saveInspection("uygunsuz", detay);
}
function callGuard(tc){
 db.ref(`personnel/${tc}/telefon`).once("value", snap => {

  if(!snap.exists() || !snap.val()){
   showAlert({
    title:"Telefon Yok",
    message:"Bu personelin kayÄ±tlÄ± telefonu yok",
    buttons:[{text:"Tamam"}]
   });
   return;
  }

  const tel = snap.val();

  showAlert({
   title:"Personel AransÄ±n mÄ±?",
   message:`ğŸ“ ${tel}`,
   buttons:[
    { text:"Ä°ptal" },
    { text:"Ara", onClick:()=>{ window.location.href=`tel:${tel}` } }
   ]
  });
 });
}

function toggleFlash(){
 if(!qrInstance) return;

 flashOn = !flashOn;

 qrInstance.applyVideoConstraints({
  advanced:[{ torch: flashOn }]
 }).catch(err=>{
  showAlert({
   title:"Flash Desteklenmiyor",
   message:"Bu cihaz flash kontrolÃ¼nÃ¼ desteklemiyor",
   buttons:[{text:"Tamam"}]
  });
 });
}
function refocusCamera(){
 if(!qrInstance) return;

 qrInstance.stop().then(()=>{
  qrInstance.start(
   { facingMode:"environment" },
   { fps:10, qrbox:250 },
   t=>{
    tcNo=t;
    qrInstance.stop();
    checkGuard();
   }
  );
 });
}
function openManual(){
 qrPage.classList.add("hidden");
 manualPage.classList.remove("hidden");
 manualTc.value = "";
 manualTc.focus();
}

function backToQr(){
  manualPage.classList.add("hidden");
  qrPage.classList.remove("hidden");

  // QR okuyucuyu baÅŸlat
  if(!qrInstance){
    qrInstance = new Html5Qrcode("qr-reader");
  }

  qrInstance.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    t => {
      tcNo = t;
      qrInstance.stop();
      checkGuard();
    }
  ).catch(err => {
    console.error("QR baÅŸlatÄ±lamadÄ±:", err);
  });
}


function manualSearch(){
 const tc = manualTc.value.trim();

 if(tc.length !== 11){
  showAlert({
   title:"GeÃ§ersiz TC",
   message:"11 haneli TC gir",
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 tcNo = tc;
 manualPage.classList.add("hidden");
 checkGuard(); // QR okutmuÅŸ gibi devam eder
}
function backToProject(){

 // Devriye baÅŸlamÄ±ÅŸsa GERÄ° DÃ–NME
 if(aktifDevriyeId){
  showAlert({
   title:"Denetleme Devam Ediyor",
   message:`ğŸ“ ${projectTitle.innerText} projesi iÃ§in denetleme baÅŸlatÄ±ldÄ±.\n\nDenetlemeyi bitirmeden proje seÃ§imine dÃ¶nemezsiniz.`,
   buttons:[{text:"Tamam"}]
  });
  return;
 }

 // Devriye yoksa NORMAL GERÄ° DÃ–N
 listPage.classList.add("hidden");
 projectPage.classList.remove("hidden");
}

let cameraStream = null;
let cameraAllowed = false;


/* FOTO SEÃ‡ENEKLERÄ° */
function openPhotoOptions(){

 const hasPhoto = !!guard.photoBase64;

 showAlert({
  title:"Profil FotoÄŸrafÄ±",
  message: hasPhoto
   ? "Yeni profil fotoÄŸrafÄ± koymak ister misin?"
   : "Profil fotoÄŸrafÄ± eklemek ister misin?",
  buttons:[
   { text:"Ä°ptal" },
   {
    text: hasPhoto ? "Yeni Profil FotoÄŸrafÄ± Koy" : "Ekle",
    onClick: () => {
 cameraAllowed = true;
 openCameraForProfile();
}

   }
  ]
 });
}


function saveProfilePhoto(canvas, quality){

 const base64 = canvas.toDataURL("image/jpeg", quality);
 const sizeKB = Math.round((base64.length * 3) / 4 / 1024);

 if(sizeKB > 300 && quality > 0.2){
  return saveProfilePhoto(canvas, quality - 0.1);
 }

 return syncPersonnel({
  tc: tcNo,
  adSoyad: guard.adSoyad,
  data: {
    photoBase64: base64
  }
 }).then(()=>{
  guard.photoBase64 = base64;
  guardPhoto.src = base64;
  guardPhoto.style.display = "block";
  photoPlus.style.display = "none";
 });
}


function openCameraForProfile(){
 if(!cameraAllowed) return;
 cameraAllowed = false;

 // varsa Ã¶nce eski kamerayÄ± kapat
 if(cameraStream){
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream = null;
 }

 navigator.mediaDevices.getUserMedia({
  video:{
   facingMode:{ ideal:"environment" } // âœ… ANDROID + IOS
  },
  audio:false
 }).then(stream=>{
  cameraStream = stream;
  camera.srcObject = stream;

  camera.onloadedmetadata = () => {
   camera.play();
  };

  cameraModal.classList.remove("hidden");
  cameraModal.style.display = "flex";
 }).catch(err=>{
  alert("Arka kamera aÃ§Ä±lamadÄ±");
  console.error(err);
 });
}


function captureProfilePhoto(){

 const vw = camera.videoWidth;
 const vh = camera.videoHeight;
 if(!vw || !vh) return Promise.reject();

 const rect = camera.getBoundingClientRect();
 const guideSize = 220;

 const guideCenterX = rect.width / 2;
 const guideCenterY = rect.height / 2;

 const videoRatio = vw / vh;
 const viewRatio  = rect.width / rect.height;

 let renderedW, renderedH, offsetX = 0, offsetY = 0;

 if(videoRatio > viewRatio){
  renderedH = rect.height;
  renderedW = renderedH * videoRatio;
  offsetX = (renderedW - rect.width) / 2;
 }else{
  renderedW = rect.width;
  renderedH = renderedW / videoRatio;
  offsetY = (renderedH - rect.height) / 2;
 }

 const scaleX = vw / renderedW;
 const scaleY = vh / renderedH;

 const sx = Math.round((guideCenterX - guideSize/2 + offsetX) * scaleX);
 const sy = Math.round((guideCenterY - guideSize/2 + offsetY) * scaleY);
 const sSize = Math.round(guideSize * scaleX);

 const canvas = document.createElement("canvas");
 canvas.width = sSize;
 canvas.height = sSize;

 const ctx = canvas.getContext("2d");
 ctx.drawImage(camera, sx, sy, sSize, sSize, 0, 0, sSize, sSize);

 // ğŸ”¥ PROMISE DÃ–NDÃœR
 return saveProfilePhoto(canvas, 0.85);
}


function captureAndClose(){
 captureProfilePhoto()
  .then(()=>{
   closeCameraModal();
   showAlert({
    title:"BaÅŸarÄ±lÄ±",
    message:"Profil fotoÄŸrafÄ± kaydedildi",
    buttons:[{text:"Tamam"}]
   });
  })
  .catch(()=>{
   showAlert({
    title:"Hata",
    message:"FotoÄŸraf alÄ±namadÄ±",
    buttons:[{text:"Tamam"}]
   });
  });
}


function closeCameraModal(){

 const modal = document.getElementById("cameraModal");
 const video = document.getElementById("camera");

 // modalÄ± kapat
 modal.classList.add("hidden");
 modal.style.display = "none";

 // kamerayÄ± durdur
 if(cameraStream){
  cameraStream.getTracks().forEach(t => t.stop());
  cameraStream = null;
 }

 // video baÄŸlantÄ±sÄ±nÄ± kes
 if(video){
  video.pause();
  video.srcObject = null;
 }
}

function logout(){

 // 1ï¸âƒ£ Manuel personel sayfasÄ±ndaysa â†’ QR'a dÃ¶n
 if(!manualPage.classList.contains("hidden")){
  manualPage.classList.add("hidden");
  qrPage.classList.remove("hidden");
  return;
 }

 // 2ï¸âƒ£ QR sayfasÄ±ndaysa â†’ listeye dÃ¶n
 if(!qrPage.classList.contains("hidden")){
  qrPage.classList.add("hidden");
  listPage.classList.remove("hidden");
  return;
 }

 // 3ï¸âƒ£ Kart / already / required sayfalarÄ±ndaysa â†’ listeye dÃ¶n
 if(
  !cardPage.classList.contains("hidden") ||
  !alreadyPage.classList.contains("hidden") ||
  !requiredPage.classList.contains("hidden")
 ){
  cardPage.classList.add("hidden");
  alreadyPage.classList.add("hidden");
  requiredPage.classList.add("hidden");
  listPage.classList.remove("hidden");
  return;
 }

 // 4ï¸âƒ£ Liste sayfasÄ±ndaysa
 if(!listPage.classList.contains("hidden")){

  // Devriye baÅŸladÄ±ysa Ã§Ä±kÄ±ÅŸ YOK
  if(aktifDevriyeId){
   showAlert({
    title:"Denetleme Devam Ediyor",
    message:"Denetlemeyi bitirmeden Ã§Ä±kamazsÄ±n",
    buttons:[{text:"Tamam"}]
   });
   return;
  }

  // Devriye yoksa â†’ proje seÃ§imine dÃ¶n
  listPage.classList.add("hidden");
  projectPage.classList.remove("hidden");
  return;
 }

 // 5ï¸âƒ£ Proje seÃ§imindeyse â†’ login'e dÃ¶n
 window.location.href = "menÃ¼.html";
}

function findPersonnelProject(tc){
  return db.ref("projects").once("value").then(snap => {

    let found = null;

    snap.forEach(p => {
      if(p.child("personnel").child(tc).exists()){
        found = {
          id: p.key,
          name: p.val().projectName
        };
      }
    });

    return found;
  });
}
function continueAsGuestGuard(isMesaide = false){

  db.ref(`personnel/${tcNo}`).once("value", snap => {

    if(!snap.exists()){
      return;
    }

    guard = snap.val();

    qrPage.classList.add("hidden");
    showCard();

    // ğŸ”´ SADECE "Mesaiye Geldi" BUTONUNDAN GELDÄ°YSE
    if(isMesaide === true){
      window.__mesaideFlag = true;
    }

  }); // â† once kapanÄ±ÅŸÄ±
}     // â† fonksiyon kapanÄ±ÅŸÄ±


function loadGuardFromPersonnel(){

  // ğŸ”¥ Ã–NCE CACHEâ€™TEN OKU
  const cached = getCachedPersonnel(tcNo);

  if(!cached){
    showAlert({
      title:"Offline Veri Yok",
      message:"Bu personel offline verilerde bulunamadÄ±",
      buttons:[{text:"Tamam"}]
    });
    return;
  }

  guard = {
    tc: tcNo,
    ...cached
  };

  // zorunlu alan kontrolÃ¼
  if(!guard.telefon || !guard.kimlikTuru || !guard.kimlikGecerlilik){
    qrPage.classList.add("hidden");
    requiredPage.classList.remove("hidden");
    return;
  }

  qrPage.classList.add("hidden");
  showCard();
}

function moveGuardToThisProject(oldProjectId){

  const updates = {};

  // âŒ eski projeden Ã§Ä±kar
  updates[`projects/${oldProjectId}/personnel/${tcNo}`] = null;

  // âœ… yeni projeye ekle
  updates[`projects/${proje}/personnel/${tcNo}`] = true;

  // ğŸ” personel ana kaydÄ±nda proje bilgisini gÃ¼ncelle
  updates[`personnel/${tcNo}/project`] = proje;

  firebase.database().ref().update(updates)
    .then(() => {
// ğŸ”¥ CACHEâ€™E EKSÄ°K VERÄ° YAZMA â†’ FIREBASEâ€™TEN TEKRAR OKU
db.ref(`personnel/${tcNo}`).once("value", snap => {
  if(snap.exists()){
    cachePersonnel(tcNo, snap.val());

    // liste aÃ§Ä±ksa anÄ±nda yenile
    if(listPage && !listPage.classList.contains("hidden")){
      guardList.innerHTML = "";
      setTimeout(loadList, 50);
    }
  }
});

// ğŸ” LÄ°STEYÄ° YENÄ°DEN Ã‡Ä°ZDÄ°R (Ä°SÄ°M ANINDA GELÄ°R)
if(listPage && !listPage.classList.contains("hidden")){
  guardList.innerHTML = "";
  setTimeout(loadList, 100);
}


// ğŸ”¥ BU PROJENÄ°N PERSONEL LÄ°STESÄ°NE EKLE (OFFLINE + UI Ä°Ã‡Ä°N)
const key = "projectPersonnel_" + proje;
const map = JSON.parse(localStorage.getItem(key) || "{}");
map[tcNo] = true;
localStorage.setItem(key, JSON.stringify(map));


      showAlert({
        title:"BaÅŸarÄ±lÄ±",
        message:"Personel artÄ±k bu projede Ã§alÄ±ÅŸÄ±yor",
        buttons:[
          {
            text:"Devam",
            onClick: () => {
              continueAsGuestGuard(); 
              // ğŸ‘† aynÄ± akÄ±ÅŸ ama artÄ±k PROJEYE AÄ°T
            }
          }
        ]
      });

    })
    .catch(() => {
      showAlert({
        title:"Hata",
        message:"Personel taÅŸÄ±nÄ±rken hata oluÅŸtu",
        buttons:[{ text:"Tamam" }]
      });
    });
}
function confirmMoveGuard(found){

  const deneticiAdi = currentProfileName?.trim() || "Denetici";
  const eskiProje   = found.name || "mevcut proje";
  const yeniProje   = projectTitle.innerText || "seÃ§ilen proje";

  showAlert({
    title:"Personel TaÅŸÄ±ma OnayÄ±",
    message:`
      <b>SayÄ±n Denetici:</b> ${deneticiAdi}<br><br>

      <span class="danger-text">${eskiProje}</span>
      <span style="opacity:.7"> projesinde kayÄ±tlÄ± olan personelin</span><br>

      <span style="font-size:18px;opacity:.5">â†“</span><br>

      <span style="color:#4dffb5;font-weight:800">${yeniProje}</span>
      <span style="opacity:.7"> projesine</span><br><br>

      <b>kalÄ±cÄ± olarak aktarÄ±lmasÄ±</b> iÅŸlemini onaylÄ±yor musunuz?
    `,
    buttons:[
      { text:"âŒ VazgeÃ§" },
      {
        text:"âœ… Evet, TaÅŸÄ±",
        danger:true,
        onClick: () => moveGuardToThisProject(found.id)
      }
    ]
  });
}

window.addEventListener("online", async ()=>{

  const key = "offlineInspections";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  if(!list.length) return;

  try{
    for(const x of list){
      await db.ref(`denetimler/${x.proje}/${x.tcNo}`).push(x.data);
    }

    localStorage.removeItem(key);

    // ğŸ”¥ Ã‡Ã–ZÃœM BURASI
    if(listPage && !listPage.classList.contains("hidden")){
      guardList.innerHTML = "";   // NET SIFIRLAMA
      setTimeout(loadList, 300);  // Firebase yazÄ±mÄ± bitsin
    }

    showAlert({
      title:"Senkron Tamam",
      message:"Offline denetimler sisteme yÃ¼klendi",
      buttons:[{text:"Tamam"}]
    });

  }catch(e){
    showAlert({
      title:"Senkron HatasÄ±",
      message:"BazÄ± offline veriler yÃ¼klenemedi",
      buttons:[{text:"Tamam"}]
    });
  }
});


function cachePersonnel(tc, data){
 const all = JSON.parse(localStorage.getItem("personnelCache") || "{}");
 all[tc] = data;
 localStorage.setItem("personnelCache", JSON.stringify(all));
}

function getCachedPersonnel(tc){
 const all = JSON.parse(localStorage.getItem("personnelCache") || "{}");
 return all[tc] || null;
}
function continueNewInspection(){
  mode = "new";
  alreadyPage.classList.add("hidden");
  loadGuardFromPersonnel(); // ğŸ”¥ guard DOLAR
}

function continueUpdateInspection(){
  mode = "update";
  alreadyPage.classList.add("hidden");
  loadGuardFromPersonnel(); // ğŸ”¥ guard DOLAR
}
// OFFLINE STATUSU HEMEN GÃ–STER / GÄ°ZLE
function checkOfflineStatus() {
  if (!navigator.onLine) {
    offlineStatus.style.display = "block"; // internet yok â†’ gÃ¶ster
  } else {
    offlineStatus.style.display = "none";  // internet var â†’ gizle
  }
}

// Sayfa yÃ¼klendiÄŸinde anÄ±nda Ã§alÄ±ÅŸtÄ±r
checkOfflineStatus();

// Online / offline deÄŸiÅŸimlerini dinle
window.addEventListener("online", checkOfflineStatus);
window.addEventListener("offline", checkOfflineStatus);

</script>
<div id="appAlert" class="hidden">
  <div class="alert-box">
    <h3 id="alertTitle"></h3>
    <p id="alertMessage"></p>
    <div id="alertActions"></div>
  </div>
</div>
<!-- ğŸ“¸ PROFÄ°L FOTO KAMERA MODALI -->
<div id="cameraModal" class="hidden"
 style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  align-items:center;
  justify-content:center;
  z-index:9999;
 ">

 <div style="position:relative;width:90%;max-width:360px;">

<video id="camera" autoplay playsinline
 style="width:100%;border-radius:16px;object-fit:cover">
</video>





  <!-- ğŸ”² KARE REHBER -->
  <div style="
   position:absolute;
   top:50%;
   left:50%;
   width:220px;
   height:220px;
   transform:translate(-50%,-50%);
   border:3px solid #00e5ff;
   border-radius:14px;
   box-shadow:0 0 0 2000px rgba(0,0,0,.55);
   pointer-events:none;
  "></div>

 <button onclick="captureAndClose()" style="margin-top:14px;width:100%">
 ğŸ“¸ Profil FotoÄŸrafÄ± OluÅŸtur
</button>


  <button onclick="closeCameraModal()"
   style="margin-top:8px;width:100%;background:#ff4d4d;color:#fff">
   âŒ Ä°ptal
  </button>

 </div>
</div>
<div id="profileModal" class="hidden"
 style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999
 ">

 <div class="card" style="width:90%;max-width:360px">

  <h3>ğŸ‘¤ Profil</h3>

  <input id="profileEmailInput" disabled>
  <input id="newPassword" type="password" placeholder="Yeni Åifre">

  <button onclick="updatePassword()">ğŸ” Åifreyi GÃ¼ncelle</button>
  <button onclick="closeProfile()" style="background:#ff4d4d;color:#fff">
   âŒ Kapat
  </button>

 </div>
</div>
<script>
/* ğŸ“¡ OFFLINE / ONLINE DURUM TAKÄ°BÄ° (ÃœST BAR + MODE + SYNC) */
async function updateOfflineStatus(){
  const el = document.getElementById("offlineStatus");

  if(navigator.onLine){

    // ğŸ”“ OFFLINE MODU KAPAT
    disableOfflineMode();

    // ğŸ“¡ ÃœST BAR GÄ°ZLE
    if(el) el.style.display = "none";

    // ğŸ”„ OFFLINE'DA GÄ°RÄ°LEN PERSONEL BÄ°LGÄ°LERÄ°NÄ° YÃœKLE
    await syncOfflinePersonnelUpdates();

  }else{

    // ğŸ”’ OFFLINE MODU AÃ‡
    enableOfflineMode();

    // ğŸ“¡ ÃœST BAR GÃ–STER
    if(el) el.style.display = "block";
  }
}

window.addEventListener("online", () => {
  updateOfflineStatus();
});

window.addEventListener("offline", () => {
  updateOfflineStatus();
});

// ilk aÃ§Ä±lÄ±ÅŸta durum kontrolÃ¼
updateOfflineStatus();


/* ğŸ”„ OFFLINE PERSONEL BÄ°LGÄ°LERÄ°NÄ° FIREBASE'E GÃ–NDER */
async function syncOfflinePersonnelUpdates(){
  const key = "offlinePersonnelUpdates";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  if(!list.length) return;

  console.log("ğŸ”„ Offline personel bilgileri Firebase'e gÃ¶nderiliyor", list);

  let hasError = false;

  for(const p of list){
    try{
      await syncPersonnel({
        tc: p.tc,
        adSoyad: p.adSoyad,
        data: p.data
      });
    }catch(err){
      console.error("âŒ Personel sync hatasÄ±:", p.tc, err);
      hasError = true;
    }
  }

  // â— SADECE TÃœMÃœ BAÅARILIYSA TEMÄ°ZLE
  if(!hasError){
    localStorage.removeItem(key);
    console.log("âœ… Offline personel kuyruÄŸu temizlendi");
  }else{
    console.warn("âš ï¸ BazÄ± personel kayÄ±tlarÄ± gÃ¶nderilemedi, kuyruk korunuyor");
  }
}


/* ğŸ”’ MOBÄ°LDE AÅAÄI Ã‡EK â†’ YENÄ°LE ENGEL */
let startY = 0;

window.addEventListener("touchstart", e => {
  startY = e.touches[0].clientY;
}, { passive: false });

window.addEventListener("touchmove", e => {
  const currentY = e.touches[0].clientY;
  if (window.scrollY === 0 && currentY > startY) {
    e.preventDefault();
  }
}, { passive: false });
setInterval(() => {
  if(navigator.onLine){
    syncOfflinePersonnelUpdates();
  }
}, 5000);
</script>

</body>
</html>  




